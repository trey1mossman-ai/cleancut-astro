name: Deploy to Hostinger via Git

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: "deploy-prod"
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build static site
        run: npm run build

      - name: Verify build output exists
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå ERROR: /dist directory does not exist!"
            exit 1
          fi
          echo "‚úÖ Build output exists"
          echo "üìä Total files: $(find dist -type f | wc -l)"
          echo "üìä Total size: $(du -sh dist | cut -f1)"

      - name: Deploy to deploy branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "üì¶ Saving build output..."
          cp -r dist /tmp/dist-deploy

          echo "üîÑ Switching to deploy branch..."
          git fetch origin deploy || git checkout --orphan deploy
          git checkout deploy || git checkout --orphan deploy

          echo "üßπ Cleaning deploy branch..."
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +

          echo "üìã Copying new build..."
          cp -r /tmp/dist-deploy/* .
          cp -r /tmp/dist-deploy/.* . 2>/dev/null || true

          echo "üìä Files to deploy:"
          ls -la
          echo ""
          echo "Total files: $(find . -type f ! -path './.git/*' | wc -l)"
          echo "Total size: $(du -sh . | cut -f1)"

          git add -A
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to deploy"
          else
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            git commit -m "Deploy: $TIMESTAMP"
            git push origin deploy
            echo "‚úÖ Successfully deployed to 'deploy' branch"
          fi

      - name: Deployment Summary
        run: |
          echo ""
          echo "================================================"
          echo "üöÄ DEPLOYMENT COMPLETE"
          echo "================================================"
          echo ""
          echo "üìç Branch: deploy"
          echo "üîó View: https://github.com/trey1mossman-ai/cleancut-astro/tree/deploy"
          echo ""
          echo "‚è≥ Hostinger will auto-pull from deploy branch"
          echo "üìç Site: http://indigo-badger-869654.hostingersite.com/"
          echo ""
          echo "================================================"
